<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=800" />
    <style>
      * {
        touch-action: manipulation;
      }
    </style>
  </head>
  <body>
    <canvas
      id="myCanvas"
      width="800" 
      height="600"
      style="border: 1px solid #d3d3d3"
    >
      Your browser does not support the HTML canvas tag.
    </canvas>
    <button onclick="permission()">Request orientation permission</button>

    <!-- <h1 id="console">console</h1> -->
    <script>
     

      var canvas = document.getElementById("myCanvas");
      var ctx = canvas.getContext("2d");
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
      var gameOver = false;
      var player = {
        pos: { x: canvas.width - 175, y: canvas.height - 50 },
        direction: 0,
        brake: 0.99,
        speed: 2.5,
        width: 150,
        height: 25,
      };
      var ball = {
        pos: { x: 325, y: 200 },
        direction: { x: 1, y: -1 },
        diameter: 10,
      };
      var blocks = [];
      generateBlocks();
      function generateBlocks() {
        for (var i = 2; i < canvas.width; i += 50) {
          var block = {
            pos: { x: i, y: 100 },
            width: 45,
            height: 10,
          };
          blocks.push(block);
        }
      }
      var FPS = 240;

      function permission() {
        console.log("test");
        if (
          typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function"
        ) {
          DeviceMotionEvent.requestPermission()
            .then((response) => {
              if (response == "granted") {
                window.addEventListener(
                  "deviceorientation",
                  handleOrientation,
                  true
                );
              }
            })
            .catch(console.error);
        } else {
          window.addEventListener("deviceorientation", handleOrientation, true);
        }
      }
      

      function handleOrientation(event) {
        player.direction = event.gamma /8;
        if(player.direction > player.speed){
          player.direction = player.speed;
        }
        if(player.direction < player.speed * -1){
          player.direction = player.speed * -1;
        }

      }
      permission();

      window.onload = function () {
        setInterval(function () {
          if (!gameOver) {
            playerMove();
            moveBall();
            refresh();
          }
        }, 1000 / FPS);
      };
      function refresh() {
        ctx.fillStyle = "Grey";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        drawPlayer();
        drawBall();
        drawBlocks();
        if (gameOver) {
          ctx.font = "60px Arial";
          ctx.fillStyle = "red";
          ctx.fillText("Game  Over!", 220, 200);
        }
      }

      function moveBall() {
        ball.pos.x += ball.direction.x * (canvas.width/800);
        ball.pos.y += ball.direction.y * (cavas.height/600);

        checkBallCollision();
      }

      function drawBlocks() {
        for (var block of blocks) {
          ctx.fillStyle = "black";
          ctx.fillRect(block.pos.x, block.pos.y, block.width, block.height);
        }
      }
      function checkBallCollision() {
        if (ball.pos.x < ball.diameter) ball.direction.x *= -1;
        if (ball.pos.x > canvas.width - ball.diameter) ball.direction.x *= -1;
        if (ball.pos.y < ball.diameter) ball.direction.y *= -1;
        if (ball.pos.y > canvas.height - ball.diameter) gameOver = true;

        if (
          ball.pos.x < player.pos.x + player.width &&
          ball.pos.x > player.pos.x &&
          ball.pos.y + ball.diameter > player.pos.y
        )
          ball.direction.y *= -1;
        for (block of blocks) {
          if (
            ball.pos.x < block.pos.x + block.width &&
            ball.pos.x > block.pos.x &&
            (Math.abs(
              ball.pos.y - ball.diameter - (block.pos.y + block.height)
            ) < 5 ||
              Math.abs(ball.pos.y + ball.diameter - block.pos.y) < 5)
          ) {
            ball.direction.y *= -1;
            blocks.splice(blocks.indexOf(block), 1);
          }
        }
      }
      function drawBall() {
        ctx.beginPath();
        ctx.arc(ball.pos.x, ball.pos.y, ball.diameter, 0, 2 * Math.PI);
        ctx.fillStyle = "yellow";
        ctx.fill();
        ctx.stroke();
      }
      function playerMove() {
        player.direction *= player.brake;

        player.pos.x += player.direction;

        if (player.pos.x < 0) player.pos.x = 0;
        if (player.pos.x > canvas.width - player.width)
          player.pos.x = canvas.width - player.width;
      }

      function drawPlayer() {
        ctx.fillStyle = "Blue";
        ctx.fillRect(player.pos.x, player.pos.y, player.width, player.height);
      }
      document.addEventListener("keydown", (event) => {
        if (event.keyCode === 37) {
          player.direction = 0;
          player.direction -= 1;
        } else if (event.keyCode === 39) {
          player.direction = 0;
          player.direction += 1;
        }
      });
    </script>
  </body>
</html>
